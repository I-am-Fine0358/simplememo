<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メモ帳</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', 'Noto Sans JP', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #editor {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            resize: none;
            border: none;
            outline: none;
            box-shadow: none;
            background-color: #ffffff;
            color: #1f2937;
        }
        #editor::-webkit-scrollbar { width: 12px; }
        #editor::-webkit-scrollbar-track { background: #f8fafc; }
        #editor::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 6px; border: 3px solid #f8fafc; }
        #editor::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .modal-backdrop { transition: opacity 0.2s ease-in-out; }
        .modal-content { transition: all 0.2s ease-in-out; }
        .btn {
            transition: all 0.15s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-slate-100 h-screen flex items-center justify-center p-4">

    <!-- メインコンテナ -->
    <div id="notepad" class="w-full max-w-4xl h-full max-h-[90vh] bg-white rounded-xl shadow-2xl flex flex-col border border-slate-200">
        
        <!-- ヘッダー -->
        <header class="bg-slate-50 p-3 border-b border-slate-200 flex items-center space-x-2 rounded-t-xl">
            <h1 id="file-title" class="text-base font-semibold text-slate-700 mr-auto truncate pr-2">無題 - メモ帳</h1>
            <button id="new-btn" class="btn flex items-center space-x-2 px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <span>新規作成</span>
            </button>
            <button id="open-btn" class="btn flex items-center space-x-2 px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" /></svg>
                <span>開く</span>
            </button>
            <button id="save-btn" class="btn flex items-center space-x-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
                <span>名前を付けて保存</span>
            </button>
        </header>

        <!-- テキスト編集エリア -->
        <main class="flex-grow h-0 relative">
            <textarea 
                id="editor" 
                class="w-full h-full p-4 text-base"
                placeholder="ここにテキストを入力してください..."
                spellcheck="false"
            ></textarea>
            <input type="file" id="file-opener" class="hidden">
        </main>

        <!-- フッター -->
        <footer class="bg-slate-50 p-2 border-t border-slate-200 text-sm text-slate-500 text-right rounded-b-xl">
            <span id="char-count">0</span> 文字
        </footer>

    </div>

    <!-- 変更確認モーダル -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal-backdrop absolute inset-0 bg-black/60"></div>
        <div class="modal-content bg-white rounded-xl shadow-xl w-full max-w-md m-4 p-6 z-10 transform scale-95">
            <h3 id="confirm-title" class="text-lg font-semibold text-slate-800 mb-2">変更を保存しますか？</h3>
            <p id="confirm-message" class="text-sm text-slate-600 mb-6">現在の内容を破棄する前に保存しますか？</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="btn px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 border border-slate-300 rounded-lg hover:bg-slate-200 focus:outline-none">キャンセル</button>
                <button id="modal-discard-btn" class="btn px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus:outline-none">保存しない</button>
                <button id="modal-save-btn" class="btn px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none">保存する</button>
            </div>
        </div>
    </div>

    <script>
        // DOM要素
        const editor = document.getElementById('editor');
        const saveBtn = document.getElementById('save-btn');
        const newBtn = document.getElementById('new-btn');
        const openBtn = document.getElementById('open-btn');
        const fileOpener = document.getElementById('file-opener');
        const charCount = document.getElementById('char-count');
        const fileTitle = document.getElementById('file-title');

        // 確認モーダル
        const confirmModal = document.getElementById('confirmation-modal');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalDiscardBtn = document.getElementById('modal-discard-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        let isContentDirty = false;
        let currentFileName = '無題.txt';
        let fileHandle = null; // File System Access APIのファイルハンドル
        let actionAfterConfirm = null; // 確認モーダル後のアクション

        // --- イベントリスナー ---
        editor.addEventListener('input', () => {
            updateCharCount();
            if (!isContentDirty) {
                fileTitle.textContent = `*${currentFileName.split('.')[0]} - メモ帳`;
            }
            isContentDirty = true;
        });

        newBtn.addEventListener('click', handleNewFile);
        openBtn.addEventListener('click', handleOpenFile);
        saveBtn.addEventListener('click', () => saveFile());
        fileOpener.addEventListener('change', openFileFallback);

        // 変更確認モーダルのボタン
        modalSaveBtn.addEventListener('click', async () => {
            hideConfirmModal();
            const saved = await saveFile();
            if (saved && typeof actionAfterConfirm === 'function') {
                actionAfterConfirm();
            }
            actionAfterConfirm = null;
        });
        modalDiscardBtn.addEventListener('click', () => {
            hideConfirmModal();
            if (typeof actionAfterConfirm === 'function') {
                actionAfterConfirm();
            }
            actionAfterConfirm = null;
        });
        modalCancelBtn.addEventListener('click', () => {
            hideConfirmModal();
            actionAfterConfirm = null;
        });
        confirmModal.querySelector('.modal-backdrop').addEventListener('click', () => {
            hideConfirmModal();
            actionAfterConfirm = null;
        });
        
        // --- ファイル操作ハンドラ ---
        function handleNewFile() {
            if (isContentDirty) {
                showConfirmModal(clearEditor);
            } else {
                clearEditor();
            }
        }

        function handleOpenFile() {
            if (isContentDirty) {
                showConfirmModal(openFile);
            } else {
                openFile();
            }
        }

        /**
         * ファイルを開く。File System Access APIが利用可能ならそれを使う。
         */
        async function openFile() {
            if ('showOpenFilePicker' in window) {
                try {
                    // ファイルタイプの指定をなくし、すべてのファイルを選択可能にする
                    const [handle] = await window.showOpenFilePicker({
                        multiple: false,
                    });
                    const file = await handle.getFile();
                    const content = await file.text();
                    
                    updateEditorWithNewFile(handle.name, content, handle);

                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('ファイルを開けませんでした。', err);
                        alert('ファイルを開けませんでした。');
                    }
                }
            } else {
                // APIが使えないブラウザ向けのフォールバック
                console.warn('File System Access API is not supported. Falling back to input method.');
                fileOpener.click(); // 隠れたinput要素をクリックさせる
            }
        }

        /**
         * 従来のファイル選択inputを使ったフォールバック用のファイルオープン処理
         * @param {Event} event 
         */
        function openFileFallback(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                updateEditorWithNewFile(file.name, content, null);
            };
            reader.onerror = (e) => {
                console.error('ファイルの読み込みに失敗しました。', e);
                alert('ファイルの読み込みに失敗しました。');
            };
            reader.readAsText(file);
            
            // 同じファイルを連続で開けるように値をリセット
            event.target.value = '';
        }

        /**
         * ファイルを保存する。
         * @returns {Promise<boolean>} 保存が成功したかどうか
         */
        async function saveFile() {
            if ('showSaveFilePicker' in window) {
                try {
                    // ファイルタイプの指定をなくし、任意の拡張子で保存しやすくする
                    const handle = await window.showSaveFilePicker({
                        suggestedName: currentFileName,
                    });
                    const writable = await handle.createWritable();
                    await writable.write(editor.value);
                    await writable.close();
                    
                    updateEditorAfterSave(handle.name, handle);
                    return true;
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('ファイルの保存に失敗しました。', err);
                        alert('ファイルの保存に失敗しました。');
                    }
                    return false;
                }
            } else {
                return saveFileFallback();
            }
        }

        /**
         * 従来のダウンロード方式を使った保存処理
         * @returns {boolean} 保存が成功したかどうか
         */
        function saveFileFallback() {
             const fileName = prompt("ファイル名を入力してください（拡張子を含む）:", currentFileName);
             if (fileName && fileName.trim() !== '') {
                try {
                    const blob = new Blob([editor.value], { type: 'text/plain;charset=utf-8' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);

                    updateEditorAfterSave(fileName, null);
                    return true;
                } catch (error) {
                    console.error("ファイル保存エラー:", error);
                    alert('ファイルの保存中にエラーが発生しました。');
                    return false;
                }
            }
            return false;
        }

        // --- UI更新/状態管理 ---
        function clearEditor() {
            editor.value = '';
            updateCharCount();
            isContentDirty = false;
            currentFileName = '無題.txt';
            fileTitle.textContent = '無題 - メモ帳';
            fileHandle = null;
        }
        
        function updateEditorWithNewFile(name, content, handle) {
            editor.value = content;
            fileHandle = handle;
            currentFileName = name;
            fileTitle.textContent = `${name.split('.')[0]} - メモ帳`;
            isContentDirty = false;
            updateCharCount();
        }

        function updateEditorAfterSave(name, handle) {
            fileHandle = handle;
            currentFileName = name;
            fileTitle.textContent = `${name.split('.')[0]} - メモ帳`;
            isContentDirty = false;
        }

        function updateCharCount() {
            charCount.textContent = editor.value.length;
        }

        // --- モーダル制御 ---
        function showConfirmModal(action) {
            actionAfterConfirm = action;
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
            // For smooth animation
            setTimeout(() => {
                const backdrop = confirmModal.querySelector('.modal-backdrop');
                const content = confirmModal.querySelector('.modal-content');
                backdrop.style.opacity = '1';
                content.style.transform = 'scale(1)';
                content.style.opacity = '1';
            }, 10);
        }

        function hideConfirmModal() {
            const backdrop = confirmModal.querySelector('.modal-backdrop');
            const content = confirmModal.querySelector('.modal-content');
            backdrop.style.opacity = '0';
            content.style.transform = 'scale(0.95)';
            content.style.opacity = '0';
            setTimeout(() => {
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
            }, 200);
        }
    </script>
</body>
</html>
