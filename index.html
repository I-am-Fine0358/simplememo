<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メモ帳</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #editor {
            font-family: 'monospace';
            resize: none;
            border: none;
            outline: none;
            box-shadow: none;
        }
        #editor::-webkit-scrollbar { width: 12px; }
        #editor::-webkit-scrollbar-track { background: #f1f1f1; }
        #editor::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 6px; }
        #editor::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        .modal-backdrop { transition: opacity 0.2s ease-in-out; }
        .modal-content { transition: transform 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-gray-200 h-screen flex items-center justify-center p-4">

    <!-- メインコンテナ -->
    <div id="notepad" class="w-full max-w-4xl h-full max-h-[90vh] bg-white rounded-lg shadow-lg flex flex-col">
        
        <!-- ヘッダー -->
        <header class="bg-gray-100 p-2 border-b border-gray-300 flex items-center space-x-2 rounded-t-lg">
            <h1 id="file-title" class="text-sm font-semibold text-gray-700 mr-auto truncate pr-2">無題 - メモ帳</h1>
            <button id="new-btn" class="px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                新規作成
            </button>
            <button id="open-btn" class="px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                開く
            </button>
            <button id="save-btn" class="px-3 py-1 text-sm bg-blue-600 text-white border border-blue-700 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                名前を付けて保存
            </button>
        </header>

        <!-- テキスト編集エリア -->
        <main class="flex-grow h-0 relative">
            <textarea 
                id="editor" 
                class="w-full h-full p-3 text-base bg-white"
                placeholder="ここにテキストを入力してください..."
                spellcheck="false"
            ></textarea>
            <input type="file" id="file-opener" class="hidden" accept=".txt,text/plain">
        </main>

        <!-- フッター -->
        <footer class="bg-gray-100 p-1 border-t border-gray-300 text-xs text-gray-600 text-right rounded-b-lg">
            <span id="char-count">0</span> 文字
        </footer>

    </div>

    <!-- 変更確認モーダル -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm m-4 p-6 z-10 transform scale-95">
            <h3 id="confirm-title" class="text-lg font-semibold text-gray-800 mb-4">変更を保存しますか？</h3>
            <p id="confirm-message" class="text-sm text-gray-600 mb-6">現在の内容を破棄する前に保存しますか？</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200 focus:outline-none">キャンセル</button>
                <button id="modal-discard-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-red-700 rounded-md hover:bg-red-700 focus:outline-none">保存しない</button>
                <button id="modal-save-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-700 rounded-md hover:bg-blue-700 focus:outline-none">保存する</button>
            </div>
        </div>
    </div>

    <script>
        // DOM要素
        const editor = document.getElementById('editor');
        const saveBtn = document.getElementById('save-btn');
        const newBtn = document.getElementById('new-btn');
        const openBtn = document.getElementById('open-btn');
        const fileOpener = document.getElementById('file-opener');
        const charCount = document.getElementById('char-count');
        const fileTitle = document.getElementById('file-title');

        // 確認モーダル
        const confirmModal = document.getElementById('confirmation-modal');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalDiscardBtn = document.getElementById('modal-discard-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        let isContentDirty = false;
        let currentFileName = '無題.txt';
        let fileHandle = null; // File System Access APIのファイルハンドル
        let actionAfterConfirm = null; // 確認モーダル後のアクション

        // --- イベントリスナー ---
        editor.addEventListener('input', () => {
            updateCharCount();
            if (!isContentDirty) {
                fileTitle.textContent = `*${currentFileName.split('.')[0]} - メモ帳`;
            }
            isContentDirty = true;
        });

        newBtn.addEventListener('click', handleNewFile);
        openBtn.addEventListener('click', handleOpenFile);
        saveBtn.addEventListener('click', () => saveFile());
        fileOpener.addEventListener('change', openFileFallback);

        // 変更確認モーダルのボタン
        modalSaveBtn.addEventListener('click', async () => {
            hideConfirmModal();
            const saved = await saveFile();
            if (saved && typeof actionAfterConfirm === 'function') {
                actionAfterConfirm();
            }
            actionAfterConfirm = null;
        });
        modalDiscardBtn.addEventListener('click', () => {
            hideConfirmModal();
            if (typeof actionAfterConfirm === 'function') {
                actionAfterConfirm();
            }
            actionAfterConfirm = null;
        });
        modalCancelBtn.addEventListener('click', () => {
            hideConfirmModal();
            actionAfterConfirm = null;
        });
        confirmModal.querySelector('.modal-backdrop').addEventListener('click', () => {
            hideConfirmModal();
            actionAfterConfirm = null;
        });
        
        // --- ファイル操作ハンドラ ---
        function handleNewFile() {
            if (isContentDirty) {
                showConfirmModal(clearEditor);
            } else {
                clearEditor();
            }
        }

        function handleOpenFile() {
            if (isContentDirty) {
                showConfirmModal(openFile);
            } else {
                openFile();
            }
        }

        /**
         * ファイルを開く。File System Access APIが利用可能ならそれを使う。
         */
        async function openFile() {
            if ('showOpenFilePicker' in window) {
                try {
                    const [handle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'テキストファイル',
                            accept: { 'text/plain': ['.txt'] },
                        }],
                        multiple: false,
                    });
                    const file = await handle.getFile();
                    const content = await file.text();
                    
                    updateEditorWithNewFile(handle.name, content, handle);

                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('ファイルを開けませんでした。', err);
                        alert('ファイルを開けませんでした。');
                    }
                }
            } else {
                // APIが使えないブラウザ向けのフォールバック
                console.warn('File System Access API is not supported. Falling back to input method.');
                fileOpener.click(); // 隠れたinput要素をクリックさせる
            }
        }

        /**
         * 従来のファイル選択inputを使ったフォールバック用のファイルオープン処理
         * @param {Event} event 
         */
        function openFileFallback(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                updateEditorWithNewFile(file.name, content, null);
            };
            reader.onerror = (e) => {
                console.error('ファイルの読み込みに失敗しました。', e);
                alert('ファイルの読み込みに失敗しました。');
            };
            reader.readAsText(file);
            
            // 同じファイルを連続で開けるように値をリセット
            event.target.value = '';
        }

        /**
         * ファイルを保存する。
         * @returns {Promise<boolean>} 保存が成功したかどうか
         */
        async function saveFile() {
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: currentFileName,
                        types: [{
                            description: 'テキストファイル',
                            accept: { 'text/plain': ['.txt'] },
                        }],
                    });
                    const writable = await handle.createWritable();
                    await writable.write(editor.value);
                    await writable.close();
                    
                    updateEditorAfterSave(handle.name, handle);
                    return true;
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('ファイルの保存に失敗しました。', err);
                        alert('ファイルの保存に失敗しました。');
                    }
                    return false;
                }
            } else {
                return saveFileFallback();
            }
        }

        /**
         * 従来のダウンロード方式を使った保存処理
         * @returns {boolean} 保存が成功したかどうか
         */
        function saveFileFallback() {
             const fileName = prompt("ファイル名を入力してください（拡張子を含む）:", currentFileName);
             if (fileName && fileName.trim() !== '') {
                try {
                    const blob = new Blob([editor.value], { type: 'text/plain;charset=utf-8' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);

                    updateEditorAfterSave(fileName, null);
                    return true;
                } catch (error) {
                    console.error("ファイル保存エラー:", error);
                    alert('ファイルの保存中にエラーが発生しました。');
                    return false;
                }
            }
            return false;
        }

        // --- UI更新/状態管理 ---
        function clearEditor() {
            editor.value = '';
            updateCharCount();
            isContentDirty = false;
            currentFileName = '無題.txt';
            fileTitle.textContent = '無題 - メモ帳';
            fileHandle = null;
        }
        
        function updateEditorWithNewFile(name, content, handle) {
            editor.value = content;
            fileHandle = handle;
            currentFileName = name;
            fileTitle.textContent = `${name.split('.')[0]} - メモ帳`;
            isContentDirty = false;
            updateCharCount();
        }

        function updateEditorAfterSave(name, handle) {
            fileHandle = handle;
            currentFileName = name;
            fileTitle.textContent = `${name.split('.')[0]} - メモ帳`;
            isContentDirty = false;
        }

        function updateCharCount() {
            charCount.textContent = editor.value.length;
        }

        // --- モーダル制御 ---
        function showConfirmModal(action) {
            actionAfterConfirm = action;
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
        }

        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
            confirmModal.classList.remove('flex');
        }
    </script>
</body>
</html>
